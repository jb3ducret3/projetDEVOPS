
#!/bin/bash

# Installer curl
sudo apt-get install curl

# Ajouter l'utilisateur prometheus
sudo useradd \
  --system \
  --no-create-home \
  --shell /bin/false prometheus

# Télécharger Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.49.0-rc.1/prometheus-2.49.0-rc.1.linux-amd64.tar.gz
tar -xvf prometheus-2.49.0-rc.1.linux-amd64.tar.gz

# Créer les répertoires pour Prometheus
sudo mkdir -p /data /etc/prometheus
cd prometheus-2.49.0-rc.1.linux-amd64/
sudo mv prometheus promtool /usr/local/bin/
sudo mv consoles console_libraries/ prometheus.yml /etc/prometheus/
sudo chown -R prometheus:prometheus /etc/prometheus/ /data/

# Vérifier la version de Prometheus
prometheus --version

# Créer le fichier de service systemd pour Prometheus
sudo tee /etc/systemd/system/prometheus.service > /dev/null <<EOF
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target
StartLimitIntervalSec=500
StartLimitBurst=5
[Service]
User=prometheus
Group=prometheus
Type=simple
Restart=on-failure
RestartSec=5s
ExecStart=/usr/local/bin/prometheus \
 -config.file=/etc/prometheus/prometheus.yml \
 -storage.tsdb.path=/data \
 -web.console.templates=/etc/prometheus/consoles \
 -web.console.libraries=/etc/prometheus/console_libraries \
 -web.listen-address=0.0.0.0:9090 \
 -web.enable-lifecycle
[Install]
WantedBy=multi-user.target
EOF

# Activer et démarrer le service Prometheus
sudo systemctl enable prometheus.service
sudo systemctl start prometheus.service

# Vérifier le statut du service Prometheus
systemctl status prometheus.service

# Ajouter l'utilisateur node_exporter
sudo useradd \
  --system \
  --no-create-home \
  --shell /bin/false node_exporter

# Télécharger et extraire Node Exporter
wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
tar -xvf node_exporter-1.7.0.linux-amd64.tar.gz
sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/

# Vérifier la version de Node Exporter
node_exporter --version

# Créer le fichier de service systemd pour Node Exporter
sudo tee /etc/systemd/system/node_exporter.service > /dev/null <<EOF
[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target
StartLimitIntervalSec=500
StartLimitBurst=5
[Service]
User=node_exporter
Group=node_exporter
Type=simple
Restart=on-failure
RestartSec=5s
ExecStart=/usr/local/bin/node_exporter \
 -collector.logind
[Install]
WantedBy=multi-user.target
EOF

# Activer et démarrer le service Node Exporter
sudo systemctl enable node_exporter
sudo systemctl start node_exporter
sudo systemctl status node_exporter.service

# Modifier la configuration Prometheus pour inclure Node Exporter
sudo tee -a /etc/prometheus/prometheus.yml > /dev/null <<EOF
- job_name: "node_exporter"
  static_configs:
    - targets: ["localhost:9100"]
EOF

# Vérifier la configuration de Prometheus
promtool check config /etc/prometheus/prometheus.yml

# Reloader la configuration Prometheus
curl -X POST http://localhost:9090/-/reload

# Installer les dépendances pour Grafana
sudo apt-get install -y apt-transport-https software-properties-common wget

# Télécharger et ajouter la clé GPG pour Grafana
sudo mkdir -p /etc/apt/keyrings/
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null

# Ajouter les dépôts Grafana
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com beta main" | sudo tee -a /etc/apt/sources.list.d/grafana.list

# Mettre à jour les paquets
sudo apt-get update

# Installer Grafana
sudo apt-get install grafana

# Activer et démarrer le service Grafana
sudo systemctl enable grafana-server.service
sudo systemctl start grafana-server.service

# Vérifier le statut du service Grafana
sudo systemctl status grafana-server.service
